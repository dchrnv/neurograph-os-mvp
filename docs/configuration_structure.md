# Система Конфигурации NeuroGraph OS

## 1. Обзор

Система конфигурации NeuroGraph OS спроектирована так, чтобы точно отражать слои нашей **Clean Architecture**. Это обеспечивает предсказуемость, модульность и простоту в управлении настройками. Конфигурация является декларативной и управляется через YAML-файлы, что позволяет легко изменять поведение системы без модификации кода.

**Ключевые принципы:**
- **Отражение архитектуры**: Структура `config/` повторяет слои `core`, `application`, `infrastructure` и `interfaces`.
- **Разделение по средам**: Файлы в `environments/` позволяют гибко настраивать приложение для разработки, тестирования и продакшена.
- **Приоритет переопределения**: Настройки загружаются в строгом порядке, где переменные окружения имеют наивысший приоритет.
- **Безопасность**: Секретные данные никогда не хранятся в репозитории и загружаются исключительно из переменных окружения.

## 2. Структура каталогов

Структура директории `config/` является зеркалом архитектуры приложения, определенной в `src/`.

```
config/
├── core/                 # Основные настройки ядра
│   ├── application/      # Настройки приложения
│   └── domain/           # Доменные настройки
│
├── environments/         # Настройки окружений
│   ├── development.yaml  # Разработка
│   ├── production.yaml   # Продакшен
│   └── testing.yaml      # Тестирование
│
├── infrastructure/       # Инфраструктурные настройки
│   ├── api.yaml         # Настройки API
│   ├── messaging.yaml   # Настройки обмена сообщениями
│   ├── persistence.yaml # Настройки хранения данных
│   └── ui.yaml          # Настройки пользовательского интерфейса
│
└── interfaces/          # Настройки интерфейсов
    ├── cli.yaml        # Командная строка
    ├── http.yaml       # HTTP API
    └── websocket.yaml  # WebSocket соединения
```

## 3. Формат конфигурационных файлов

### 3.1. Окружения (environments/)

Каждый файл окружения определяет переменные, специфичные для среды выполнения.

**Пример `development.yaml`:**
```yaml
# Базовые настройки
app:
  env: development
  debug: true
  log_level: DEBUG

# Настройки базы данных
database:
  host: localhost
  port: 5432
  name: myapp_dev
  user: dev_user

# Настройки кэша
cache:
  enabled: true
  ttl: 3600
```

### 3.2. Инфраструктура (infrastructure/)

**Пример `api.yaml`:**
```yaml
server:
  host: 0.0.0.0
  port: 8000
  workers: 4
  reload: ${APP_DEBUG:false}

security:
  secret_key: ${SECRET_KEY:your-secret-key}
  token_ttl: 3600

cors:
  enabled: true
  allow_origins: ["*"]
  allow_methods: ["*"]
  allow_headers: ["*"]
```

**Пример `persistence.yaml`:**
```yaml
# Настройки базы данных
postgresql:
  host: ${DB_HOST:localhost}
  port: ${DB_PORT:5432}
  database: ${DB_NAME:app_db}
  user: ${DB_USER:postgres}
  password: ${DB_PASSWORD:}
  pool_size: 10
  max_overflow: 20

# Настройки Redis
redis:
  host: ${REDIS_HOST:localhost}
  port: ${REDIS_PORT:6379}
  db: ${REDIS_DB:0}
```

## 4. Загрузка конфигурации

Конфигурация загружается с учетом иерархии:
1. Загружаются настройки из `environments/{env}.yaml`
2. Переопределяются значениями из соответствующих модулей
3. Применяются переменные окружения (имеют наивысший приоритет)

## 5. Переменные окружения

Ключевые переменные окружения:

```bash
# Окружение
APP_ENV=development
APP_DEBUG=true

# База данных
DB_HOST=localhost
DB_PORT=5432
DB_NAME=myapp
DB_USER=user
DB_PASSWORD=secret

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379

# Безопасность
SECRET_KEY=your-secret-key
```

## 6. Использование в коде

```python
from config import load_config

# Загрузка конфигурации
config = load_config(env='development')

# Доступ к настройкам
db_config = config.get('database')
api_config = config.get('api')
```

## 7. Переопределение настроек

### 7.1. Приоритет настроек

Настройки загружаются в следующем порядке приоритета (от низшего к высшему):

1. Значения по умолчанию в коде
2. Значения из `config/core/**/*.yaml`
3. Значения из `config/infrastructure/*.yaml`
4. Значения из `config/interfaces/*.yaml`
5. Значения из `config/environments/{env}.yaml`
6. Переменные окружения (наивысший приоритет)

### 7.2. Переменные окружения

Все настройки могут быть переопределены через переменные окружения:
- Точка (`.`) в именах секций заменяется на `__` (двойное подчеркивание)
- Верхний регистр и snake_case
- Префикс `APP_` для глобальных настроек

**Примеры:**
```bash
# Переопределение настроек базы данных
APP_DATABASE__HOST=db.example.com
APP_DATABASE__PORT=5432

# Переопределение настроек Redis
APP_REDIS__HOST=redis.example.com
```

## 8. Рекомендации

### 8.1. Разработка
- Используйте `development.yaml` для локальной разработки
- Добавьте `*.local.yaml` в `.gitignore` для локальных переопределений
- Используйте `.env` файлы для хранения локальных секретов (добавьте `.env` в `.gitignore`)
- Включите валидацию конфигурации при запуске приложения

### 8.2. Продакшен
- Всегда используйте переменные окружения для хранения секретов
- Отключите режим отладки (`APP_DEBUG=false`)
- Настройте централизованное логирование
- Используйте секреты Kubernetes или аналогичные решения для хранения чувствительных данных

### 8.3. Тестирование
- Используйте `testing.yaml` для тестов
- Настройте изолированную тестовую БД
- Используйте фикстуры для предсказуемых тестовых данных
- Очищайте состояние между тестами

## 9. Расширение конфигурации

### 9.1. Добавление новых настроек
1. Создайте новый YAML файл в соответствующей директории
2. Добавьте документацию в этот файл
3. Обновите схему валидации (если используется)
4. Протестируйте загрузку новых настроек

### 9.2. Валидация

Рекомендуется использовать библиотеки для валидации конфигурации, например `pydantic`:

```python
from pydantic import BaseSettings, Field

class DatabaseSettings(BaseSettings):
    host: str = Field(..., env="DB_HOST")
    port: int = Field(5432, env="DB_PORT")
    name: str = Field(..., env="DB_NAME")
    user: str = Field(..., env="DB_USER")
    password: str = Field(..., env="DB_PASSWORD")

    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"
```

## 10. Миграция настроек

При изменении структуры конфигурации:
1. Сохраняйте обратную совместимость
2. Используйте значения по умолчанию для новых полей
3. Предусмотрите устаревание (deprecation) старых параметров
4. Обновите документацию
5. Сообщите о изменениях в changelog

## 11. Безопасность

- Никогда не коммитьте секреты в репозиторий
- Используйте `.gitignore` для конфиденциальных файлов
- Ограничьте доступ к файлам с настройками
- Используйте менеджер секретов для продакшена
- Регулярно обновляйте секреты и ключи доступа
