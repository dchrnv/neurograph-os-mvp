# Сущность "Токен" (Token)

## Назначение
**Токен** — это атомарная единица данных и смысла в NeuroGraph OS. Он служит универсальным контейнером для представления любой сущности, связывая её положение в многомерном пространстве (`Где?`) с её контекстом и свойствами (`Кто/Что/Когда?`).

## Архитектурные принципы
- **Бинарный формат**: Для максимальной производительности и компактности, токен хранится и передается как бинарный блок данных.
- **Фиксированный размер**: Все токены имеют одинаковый размер (64 байта), что упрощает хранение, индексацию и пакетную обработку.
- **Пространственная привязка**: Ключевой особенностью является возможность задавать координаты токена на 8 различных уровнях вложенности, что позволяет представлять сложные и иерархические пространственные отношения.
- **Частичная заполняемость**: Токен может быть частично заполнен (не все уровни имеют координаты), что позволяет системе "наращивать" его по мере получения новой информации.

## Бинарная спецификация (64 байта)

Токен представляет собой 64-байтный бинарный блок данных со следующей структурой (в формате `struct`, кодировка Little-Endian `<`):

> **Примечание:** Эта структура также формально описана в машиночитаемом формате в файле `config/specs/token_config.json`.

| Смещение | Размер | Тип (`struct`) | Поле          | Описание                                            |
|----------|--------|----------------|---------------|-----------------------------------------------------|
| 0        | 48     | `<24h`         | `coordinates` | 8 уровней × 3 координаты (x, y, z) × `int16`        |
| 48       | 4      | `<I`           | `id`          | Уникальный идентификатор токена (`uint32`)          |
| 52       | 2      | `<H`           | `flags`       | Битовая маска для хранения состояний (`uint16`)     |
| 54       | 4      | `<f`           | `weight`      | Вес или значимость токена (`float32`)               |
| 58       | 2      | `<H`           | `reserved`    | Зарезервировано для будущего использования (`uint16`) |
| 60       | 4      | `<I`           | `timestamp`   | Unix-время создания или обновления (`uint32`)       |

### Семантика пространственных уровней

8-уровневая структура координат формирует семантическую "сетку", которая позволяет ответить на вопрос: «Что значит этот токен и как он действует в различных пространствах?»

#### 1. Ядро: Непосредственная Реальность (Уровни 0–2)
Эти слои определяют "телесность" и непосредственное взаимодействие токена.

| Уровень | Название   | Описание                                                              |
|---------|------------|-----------------------------------------------------------------------|
| 0 (L1)  | `physical` | **Физическое**: Сырые данные. Местоположение в памяти или физической структуре. |
| 1 (L2)  | `sensory`  | **Сенсорное**: Прямые входные данные. Как токен "воспринимает" окружение. |
| 2 (L3)  | `motor`    | **Моторное**: Выходные данные. Как токен "действует" или меняет граф.     |

#### 2. Внутренняя Обработка (Уровни 3–4)
Эти слои определяют "ментальное состояние" и внутреннюю интерпретацию токена.

| Уровень | Название    | Описание                                                              |
|---------|-------------|-----------------------------------------------------------------------|
| 3 (L4)  | `emotional` | **Эмоциональное**: Валентность. Важность, приоритет, вес или "эмоциональный окрас". |
| 4 (L5)  | `cognitive` | **Когнитивное**: Логическая функция. Синтаксическое и семантическое значение. |

#### 3. Расширенный Контекст (Уровни 5–7)
Эти слои определяют "жизнь" токена в широком, сложном мире.

| Уровень | Название   | Описание                                                              |
|---------|------------|-----------------------------------------------------------------------|
| 5 (L6)  | `social`   | **Социальное**: Контекст отношений. Значение, определяемое связями с другими. |
| 6 (L7)  | `temporal` | **Темпоральное**: Контекст времени. История, эволюция, предсказуемая траектория. |
| 7 (L8)  | `abstract` | **Абстрактное**: Концептуальная сущность. Мета-значение как идеи или принципа. |

### Кодирование полей

#### Координаты (`coordinates`)
- Каждая координата (x, y, z) хранится как 2-байтовое целое число (`int16`).
- Для экономии места используется фиксированная точность: значения с плавающей точкой в диапазоне `[-1.0, 1.0]` умножаются на 100 и округляются до целого. Например, `0.33` становится `33`, а `-0.20` становится `-20`.
- Специальное значение `127` используется для обозначения отсутствия координат на данном уровне.

#### Флаги (`flags`)
16-битное поле, где каждый бит может использоваться как флаг для обозначения булевых свойств токена (например, `IS_ACTIVE`, `IS_LOCKED` и т.д.).

## Программный интерфейс (Python API)

Класс `Token` в `src/core/token/token.py` предоставляет удобный интерфейс для работы с бинарными данными.

### Основные методы

- `__init__(buffer: Optional[bytes] = None)`
  Создает новый пустой токен или десериализует его из предоставленного бинарного буфера.

- `pack() -> bytes`
  Сериализует текущее состояние токена в 64-байтный бинарный блок.

- `set_coordinates(level: int, x: float, y: float, z: float) -> None`
  Устанавливает координаты для указанного уровня (от 0 до 7). Автоматически выполняет масштабирование.

- `get_coordinates(level: int) -> Optional[Tuple[float, float, float]]`
  Возвращает кортеж с координатами `(x, y, z)` для указанного уровня или `None`, если координаты отсутствуют.

- `to_json() -> Dict[str, Any]`
  Экспортирует содержимое токена в человекочитаемый JSON-формат.

## Пример использования

```python
from src.core.token.token import Token

# Создание нового токена
token = Token()
token.set_coordinates(0, 0.5, -0.3, 0.8)
token.id = 42
token.weight = 0.75

# Сериализация в бинарный формат
binary_data = token.pack()
print(f"Размер бинарных данных: {len(binary_data)} байт")

# Десериализация из бинарных данных
new_token = Token(binary_data)
print(f"ID восстановленного токена: {new_token.id}")
print(f"Координаты на уровне 0: {new_token.get_coordinates(0)}")
```

## Ограничения
- Фиксированный размер 64 байта
- Ограниченное количество уровней (8)
- Точность координат: 2 знака после запятой
