{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Experience Subsystem Configuration",
  "description": "Configuration for ExperienceStream, event formats, batching and backends.",
  "type": "object",
  "properties": {
    "enabled": {"type": "boolean", "default": true},
    "stream": {
      "type": "object",
      "properties": {
        "batch_size": {"type": "integer", "default": 16, "minimum": 1},
        "flush_interval": {"type": "number", "default": 1.0, "minimum": 0.01},
        "backend": {"type": "string", "enum": ["console", "file", "http"], "default": "console"},
        "file_path": {"type": "string", "description": "Path for JSONL output when backend=file."},
        "http_endpoint": {"type": "string", "description": "POST endpoint for batched events when backend=http."},
        "retain_in_memory": {"type": "boolean", "default": true, "description": "Keep copy of events in memory buffer after flush (for debug)."},
        "max_buffer_size": {"type": "integer", "default": 10000}
      },
      "additionalProperties": false
    },
    "storage": {
      "type": "object",
      "properties": {
        "circular_buffer_size": {"type": "integer", "default": 100000},
        "sliding_window_size": {"type": "integer", "default": 1000000},
        "sliding_window_duration_hours": {"type": "number", "default": 24}
      }
    },
    "sampling": {
      "type": "object",
      "properties": {
        "default_strategy": {"type": "string", "enum": ["uniform", "prioritized", "recent", "diverse"], "default": "uniform"},
        "prioritized_alpha": {"type": "number", "default": 0.6},
        "prioritized_beta": {"type": "number", "default": 0.4},
        "recent_window_size": {"type": "integer", "default": 10000}
      }
    },
    "causality_tracking": {
      "type": "object",
      "properties": {
        "enabled": {"type": "boolean", "default": true},
        "auto_link_threshold_ms": {"type": "integer", "default": 100},
        "max_chain_depth": {"type": "integer", "default": 10}
      }
    },
    "integration": {
      "type": "object",
      "properties": {
        "dna_guardian_integration": {"type": "boolean", "default": true},
        "auto_record_token_events": {"type": "boolean", "default": true}
      }
    },
    "event": {
      "type": "object",
      "properties": {
        "schema_version": {"type": "string", "default": "1.0"},
        "fields": {
          "type": "object",
          "properties": {
            "event_id": {"type": "string"},
            "event_type": {"type": "string"},
            "timestamp": {"type": "number"},
            "source_component": {"type": "string"},
            "data": {"type": "object"},
            "reward": {"type": ["number", "null"]}
          }
        }
      }
    },
    "retention": {
      "type": "object",
      "properties": {
        "enabled": {"type": "boolean", "default": false},
        "backend": {"type": "string", "enum": ["none", "redis", "postgres"], "default": "none"},
        "redis": {"type": "object", "properties": {"url": {"type": "string"}}},
        "postgres": {"type": "object", "properties": {"dsn": {"type": "string"}}}
      }
    },
    "rl_defaults": {
      "type": "object",
      "properties": {
        "reward_scale": {"type": "number", "default": 1.0},
        "discount_gamma": {"type": "number", "default": 0.99}
      }
    }
  },
  "required": ["enabled"]
}
